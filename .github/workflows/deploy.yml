name: Vibefi Monad Pipeline

on:
  push:
    branches: [ "vibefi" ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  # ------------------------------------------------------------------
  # JOB 1: FRONTEND (vibefi-app)
  # ------------------------------------------------------------------
  frontend-check:
    name: ðŸ§ª Test Frontend
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./vibefi-app  # Points to your Next.js app
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 1. SETUP PNPM
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      # 2. SETUP NODE (With pnpm cache)
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'pnpm'
          cache-dependency-path: ./vibefi-app/pnpm-lock.yaml

      - name: Install Dependencies
        run: pnpm install

      - name: Run Tests
        run: pnpm test

      - name: Build Check
        run: pnpm run build

  # ------------------------------------------------------------------
  # JOB 2: SMART CONTRACTS (Root)
  # ------------------------------------------------------------------
  contract-deploy:
    name: â›“ï¸ Deploy Contracts
    runs-on: ubuntu-latest
    outputs:
      contract_updated: ${{ steps.changes.outputs.contracts }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          ref: vibefi

      - name: Check for Contract Changes
        uses: dorny/paths-filter@v2
        id: changes
        with:
          filters: |
            contracts:
              - 'contracts/**'
              - 'hardhat.config.js'

      # Setup pnpm for Root
      - name: Setup pnpm
        if: steps.changes.outputs.contracts == 'true'
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node/Hardhat
        if: steps.changes.outputs.contracts == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'pnpm'

      - name: Install Contract Deps
        if: steps.changes.outputs.contracts == 'true'
        run: pnpm install

      - name: Deploy to Monad
        if: steps.changes.outputs.contracts == 'true'
        id: deploy
        env:
          PRIVATE_KEY: ${{ secrets.PRIVATE_KEY }}
          MONAD_RPC_URL: ${{ secrets.MONAD_RPC_URL }}
        run: |
          echo "Deploying..."
          # Using pnpm hardhat instead of npx
          pnpm hardhat run scripts/deploy.js --network monad > deployment-output.txt
          
          NEW_ADDRESS=$(grep -oE '0x[a-fA-F0-9]{40}' deployment-output.txt | head -n 1)
          
          if [ -z "$NEW_ADDRESS" ]; then
            echo "::error::âŒ Failed to capture Address!"
            exit 1
          fi
          echo "NEW_ADDRESS=$NEW_ADDRESS" >> $GITHUB_ENV

      # ------------------------------------------------------------------
      # SAVE JSON TO THE SUBDIRECTORY
      # ------------------------------------------------------------------
      - name: Update Config File
        if: steps.changes.outputs.contracts == 'true'
        run: |
          mkdir -p ./vibefi-app/app/config
          echo "{ \"contractAddress\": \"${{ env.NEW_ADDRESS }}\" }" > ./vibefi-app/app/config/contract-address.json

      - name: Commit New Address
        if: steps.changes.outputs.contracts == 'true'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ðŸ¤– CI: Updated Contract Address [skip ci]"
          branch: vibefi
          file_pattern: vibefi-app/app/config/contract-address.json

  # ------------------------------------------------------------------
  # JOB 3: MERGE (Same as before)
  # ------------------------------------------------------------------
  merge-to-main:
    name: ðŸ”€ Merge to Main
    runs-on: ubuntu-latest
    needs: [frontend-check, contract-deploy]
    if: success()
    steps:
      - name: Checkout Main
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config --global user.name 'GitHub Actions Bot'
          git config --global user.email 'actions@github.com'

      - name: Merge Vibefi
        run: |
          git fetch origin vibefi
          git merge origin/vibefi --no-ff -m "ðŸ”€ Auto-merge vibefi to main"
          git push origin main
      
      - name: Error Notification
        if: failure()
        run: |
          echo "::error::â›” MERGE FAILED."
          exit 1

  # ------------------------------------------------------------------
  # JOB 4: RELOAD VERCEL
  # ------------------------------------------------------------------
  deploy-prod:
    name: ðŸš€ Reload Vercel
    runs-on: ubuntu-latest
    needs: merge-to-main
    if: success()
    steps:
      - name: Checkout Main
        uses: actions/checkout@v4
        with:
          ref: main 

      - name: Deploy to Vercel
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod'