name: Vibefi Monad Pipeline

on:
  push:
    branches: [ "vibefi" ]  # 1. ONLY TRIGGERS ON VIBEFI
  workflow_dispatch:

permissions:
  contents: write # Required for merging and committing changes

jobs:
  # ------------------------------------------------------------------
  # JOB 1: TEST FRONTEND (The Quality Gate)
  # ------------------------------------------------------------------
  frontend-check:
    name: ðŸ§ª Test Frontend
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Run Tests
        run: npm test
        # IF THIS FAILS, THE WORKFLOW DIES HERE. NO MERGE.

      - name: Build Check
        run: npm run build

  # ------------------------------------------------------------------
  # JOB 2: SMART CONTRACTS (Deploy & Update Address)
  # ------------------------------------------------------------------
  contract-deploy:
    name: â›“ï¸ Deploy Contracts
    runs-on: ubuntu-latest
    outputs:
      contract_updated: ${{ steps.changes.outputs.contracts }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          ref: vibefi  # Ensure we are on vibefi branch

      # Check if contracts actually changed
      - name: Check for Contract Changes
        uses: dorny/paths-filter@v2
        id: changes
        with:
          filters: |
            contracts:
              - 'contracts/**'
              - 'hardhat.config.js'

      - name: Setup Node/Hardhat
        if: steps.changes.outputs.contracts == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'

      - name: Install Contract Deps
        if: steps.changes.outputs.contracts == 'true'
        run: npm ci

      - name: Deploy to Monad
        if: steps.changes.outputs.contracts == 'true'
        id: deploy
        env:
          PRIVATE_KEY: ${{ secrets.PRIVATE_KEY }}
          MONAD_RPC_URL: ${{ secrets.MONAD_RPC_URL }}
        run: |
          echo "Deploying..."
          npx hardhat run scripts/deploy.js --network monad > deployment-output.txt
          
          # GRAB THE ADDRESS
          NEW_ADDRESS=$(grep -oE '0x[a-fA-F0-9]{40}' deployment-output.txt | head -n 1)
          
          if [ -z "$NEW_ADDRESS" ]; then
            echo "::error::âŒ Failed to capture Contract Address! Check deploy.js output."
            exit 1
          fi

          echo "NEW_ADDRESS=$NEW_ADDRESS" >> $GITHUB_ENV

      - name: Update Config File
        if: steps.changes.outputs.contracts == 'true'
        run: echo "{ \"contractAddress\": \"${{ env.NEW_ADDRESS }}\" }" > ./src/config/contract-address.json

      - name: Commit New Address to Vibefi
        if: steps.changes.outputs.contracts == 'true'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ðŸ¤– CI: Updated Contract Address [skip ci]"
          branch: vibefi

  # ------------------------------------------------------------------
  # JOB 3: THE MERGE (Vibefi -> Main)
  # ------------------------------------------------------------------
  merge-to-main:
    name: ðŸ”€ Merge to Main
    runs-on: ubuntu-latest
    needs: [frontend-check, contract-deploy] # WAIT FOR BOTH TO PASS
    if: success() # ONLY RUN IF PREVIOUS JOBS SUCCEEDED
    steps:
      - name: Checkout Main
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0 # Fetch all history for merge

      - name: Configure Git
        run: |
          git config --global user.name 'GitHub Actions Bot'
          git config --global user.email 'actions@github.com'

      - name: Merge Vibefi
        run: |
          echo "Attempting to merge vibefi into main..."
          git fetch origin vibefi
          git merge origin/vibefi --no-ff -m "ðŸ”€ Auto-merge vibefi to main after successful tests"
          git push origin main
      
      - name: Error Notification
        if: failure()
        run: |
          echo "::error::â›” MERGE FAILED. Frontend or Contract checks did not pass."
          exit 1

  # ------------------------------------------------------------------
  # JOB 4: RELOAD VERCEL (Production Deploy)
  # ------------------------------------------------------------------
  deploy-prod:
    name: ðŸš€ Reload Vercel
    runs-on: ubuntu-latest
    needs: merge-to-main # WAIT FOR MERGE
    if: success()
    steps:
      - name: Checkout Main
        uses: actions/checkout@v4
        with:
          ref: main # Deploy the freshly merged main code

      - name: Deploy to Vercel
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod' # Triggers production reload